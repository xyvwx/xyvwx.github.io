<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>球体渲染与Phong光照模型</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix-min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .canvas-container {
            flex: 1;
            min-width: 500px;
        }
        .controls {
            flex: 1;
            min-width: 300px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        canvas {
            border: 1px solid #ccc;
            background: #1a1a1a;
            display: block;
        }
        .control-group {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        select, button, input {
            margin: 5px;
            padding: 8px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .color-preview {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 1px solid #ccc;
            vertical-align: middle;
        }
        .subdivision-info {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }
        .key-controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">球体渲染与Phong光照模型</h1>
    
    <div class="container">
        <div class="canvas-container">
            <canvas id="gl-canvas" width="600" height="500"></canvas>
            <div style="text-align: center; margin-top: 10px;">
                <select id="shading-mode">
                    <option value="6" selected>Phong着色</option>
                </select>
                <button onclick="resetView()">重置视角 (R)</button>
            </div>
            
            <!-- 按键说明移到左侧图片下面 -->
            <div class="key-controls">
                <h3>控制说明</h3>
                <table>
                    <tr>
                        <th>按键</th>
                        <th>功能</th>
                    </tr>
                    <tr>
                        <td>A / D</td>
                        <td>增加/减少 theta (水平旋转)</td>
                    </tr>
                    <tr>
                        <td>W / S</td>
                        <td>增加/减少 phi (垂直旋转)</td>
                    </tr>
                    <tr>
                        <td>Z / X</td>
                        <td>增大/减小半径</td>
                    </tr>
                    <tr>
                        <td>V / B</td>
                        <td>增加/减少细分级别</td>
                    </tr>
                    <tr>
                        <td>R</td>
                        <td>重置视角</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="controls">
            <!-- 右侧控制面板，其他表单位置上移 -->
            <div class="control-group">
                <h3>光照参数</h3>
                <div>
                    <label>光源位置 X: 
                        <input type="range" id="light-x" min="-10" max="10" step="0.5" value="0" onchange="updateLightX(this.value)">
                        <span id="light-x-value">0.0</span>
                    </label>
                </div>
                <div>
                    <label>光源位置 Y: 
                        <input type="range" id="light-y" min="-10" max="10" step="0.5" value="0" onchange="updateLightY(this.value)">
                        <span id="light-y-value">0.0</span>
                    </label>
                </div>
                <div>
                    <label>光源位置 Z: 
                        <input type="range" id="light-z" min="-10" max="10" step="0.5" value="-10" onchange="updateLightZ(this.value)">
                        <span id="light-z-value">-10.0</span>
                    </label>
                </div>
                <div>
                    <label>光源类型: 
                        <select id="light-type" onchange="updateLightType(this.value)">
                            <option value="0">定向光</option>
                            <option value="1" selected>点光源</option>
                        </select>
                    </label>
                </div>
            </div>
            
            <div class="control-group">
                <h3>材质参数</h3>
                <div>
                    <label>环境光反射: 
                        <input type="color" id="ambient-color" value="#FF6B6B" onchange="updateAmbientColor(this.value)">
                        <div class="color-preview" id="ambient-preview" style="background-color: #FF6B6B;"></div>
                    </label>
                </div>
                <div>
                    <label>漫反射: 
                        <input type="color" id="diffuse-color" value="#4ECDC4" onchange="updateDiffuseColor(this.value)">
                        <div class="color-preview" id="diffuse-preview" style="background-color: #4ECDC4;"></div>
                    </label>
                </div>
                <div>
                    <label>高光反射: 
                        <input type="color" id="specular-color" value="#FFFFFF" onchange="updateSpecularColor(this.value)">
                        <div class="color-preview" id="specular-preview" style="background-color: #FFFFFF;"></div>
                    </label>
                </div>
                <div>
                    <label>光泽度: 
                        <input type="range" id="shininess" min="1" max="100" value="60" onchange="updateShininess(this.value)">
                        <span id="shininess-value">60</span>
                    </label>
                </div>
            </div>
            
            <div class="control-group">
                <h3>球体参数</h3>
                <div>
                    <label>细分级别: 
                        <input type="range" id="subdivisions" min="0" max="6" value="5" onchange="updateSubdivisions(this.value)">
                        <span id="subdivisions-value">5</span>
                    </label>
                    <div class="subdivision-info">
                        细分：0-1: 低精度 | 2-3: 中等精度 | 4-6: 高精度
                    </div>
                </div>
                <div>
                    <label>三角形数量: <span id="triangle-count">5120</span></label>
                </div>
                <button onclick="updateSphere()">更新球体</button>
            </div>
            
            <div class="control-group">
                <h3>背景颜色</h3>
                <div>
                    <label>背景色: 
                        <input type="color" id="bg-color" value="#1a1a1a" onchange="updateBackgroundColor(this.value)">
                        <div class="color-preview" id="bg-preview" style="background-color: #1a1a1a;"></div>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/render.js"></script>
    <script>
        let renderer = null;
        
        function init() {
            renderer = new Renderer('gl-canvas');
            if (renderer.init()) {
                // 开始渲染循环
                function animate() {
                    renderer.display();
                    requestAnimationFrame(animate);
                }
                animate();
                
                // 设置键盘事件
                document.addEventListener('keydown', (e) => {
                    renderer.handleKeyDown(e);
                });
                
                document.addEventListener('keyup', (e) => {
                    renderer.handleKeyUp(e);
                });
                
                // 设置着色模式切换
                document.getElementById('shading-mode').addEventListener('change', (e) => {
                    renderer.setShadingMode(parseInt(e.target.value));
                });
                
                // 设置背景颜色控制
                document.getElementById('bg-color').addEventListener('input', (e) => {
                    updateBackgroundColor(e.target.value);
                });
                
                // 更新三角形数量显示
                updateTriangleCount();
                
                console.log('渲染器初始化成功');
            }
        }
        
        function resetView() {
            if (renderer) renderer.resetView();
        }
        
        function updateLightX(value) {
            if (renderer) {
                renderer.lightPosition[0] = parseFloat(value);
                document.getElementById('light-x-value').textContent = value;
            }
        }
        
        function updateLightY(value) {
            if (renderer) {
                renderer.lightPosition[1] = parseFloat(value);
                document.getElementById('light-y-value').textContent = value;
            }
        }
        
        function updateLightZ(value) {
            if (renderer) {
                renderer.lightPosition[2] = parseFloat(value);
                document.getElementById('light-z-value').textContent = value;
            }
        }
        
        function updateLightType(value) {
            if (renderer) {
                renderer.lightPosition[3] = parseFloat(value);
            }
        }
        
        function updateAmbientColor(hex) {
            if (renderer) {
                const color = hexToRgb(hex);
                renderer.materialAmbient[0] = color.r / 255;
                renderer.materialAmbient[1] = color.g / 255;
                renderer.materialAmbient[2] = color.b / 255;
                document.getElementById('ambient-preview').style.backgroundColor = hex;
            }
        }
        
        function updateDiffuseColor(hex) {
            if (renderer) {
                const color = hexToRgb(hex);
                renderer.materialDiffuse[0] = color.r / 255;
                renderer.materialDiffuse[1] = color.g / 255;
                renderer.materialDiffuse[2] = color.b / 255;
                document.getElementById('diffuse-preview').style.backgroundColor = hex;
            }
        }
        
        function updateSpecularColor(hex) {
            if (renderer) {
                const color = hexToRgb(hex);
                renderer.materialSpecular[0] = color.r / 255;
                renderer.materialSpecular[1] = color.g / 255;
                renderer.materialSpecular[2] = color.b / 255;
                document.getElementById('specular-preview').style.backgroundColor = hex;
            }
        }
        
        function updateShininess(value) {
            if (renderer) {
                renderer.materialShininess = parseFloat(value);
                document.getElementById('shininess-value').textContent = value;
            }
        }
        
        function updateSubdivisions(value) {
            document.getElementById('subdivisions-value').textContent = value;
            updateTriangleCount();
        }
        
        function updateSphere() {
            if (renderer) {
                const subdivisions = parseInt(document.getElementById('subdivisions').value);
                renderer.setSubdivisions(subdivisions);
                updateTriangleCount();
            }
        }
        
        function updateTriangleCount() {
            if (renderer) {
                const subdivisions = parseInt(document.getElementById('subdivisions').value);
                // 计算三角形数量：每个四面体细分后产生的三角形数量
                const trianglesPerTetra = Math.pow(4, subdivisions) * 4; // 4个面 * 4^细分级别
                document.getElementById('triangle-count').textContent = trianglesPerTetra;
            }
        }
        
        function updateBackgroundColor(hex) {
            if (renderer) {
                const color = hexToRgb(hex);
                renderer.setClearColor(color.r / 255, color.g / 255, color.b / 255, 1.0);
                document.getElementById('bg-preview').style.backgroundColor = hex;
                document.getElementById('gl-canvas').style.backgroundColor = hex;
            }
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : {r: 0, g: 0, b: 0};
        }
        
        window.addEventListener('load', init);
    </script>
</body>
</html>